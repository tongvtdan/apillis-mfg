# Requirements Document: Feature 10 - Supplier Management & RFQ Engine

##### *Content generated by Qwen3-max-preview*

# ğŸ§© **Factory Pulse â€” Supplier Management Module Specification**  
*Self-Contained, End-to-End Design Document*  
*Aligned with PRD v1.2, Tech Stack v1.0.0, and Factory Pulse End-to-End Blueprint*

---

## ğŸ“Œ **Table of Contents**

1. **Module Overview**
2. **Business Objectives & KPIs**
3. **Target Users & Personas**
4. **Functional Requirements**
5. **Data Model (Supabase DDL)**
6. **Workflow & Qualification Engine**
7. **UI/UX Design (Text-Based Figma Spec)
8. **Technical Implementation (Frontend + Backend)**
9. **Security, Compliance & Audit**
10. **Reporting & Analytics**
11. **Integration Dependencies**
12. **Implementation Roadmap (Phased)**
13. **Success Metrics & QA Checklist**
14. **Appendix: Document Categories, Enums, Seed Data**

---

## 1. ğŸ¯ **Module Overview**

**Module Name**: Supplier Management with Qualification & Exception Handling  
**Wave**: Wave 2 (Execution Core) â€” Deployed after Wave 1 (Quoting)  
**Owner**: Procurement Team  
**Stakeholders**: Procurement, Sourcing, Quality, Engineering, Legal, Finance, Suppliers  
**Goal**: Centralize supplier onboarding, qualification, performance tracking, and RFQ distribution â€” ensuring only **qualified or conditionally approved suppliers** receive RFQs and can be assigned to projects.

> âœ… **Core Philosophy**:  
> - Every supplier must pass through a **structured qualification workflow** before being eligible for RFQs.  
> - Support **partial approval** ("Approve with Conditions") and **exceptional approval** ("Approve as Exception") for real-world flexibility.  
> - Maintain **full audit trail** for ISO 9001, AS9100, IATF 16949 compliance.  
> - Enforce **multi-tenancy** via `organization_id` and **RLS**.

---

## 2. ğŸ“Š **Business Objectives & KPIs**

| Objective                                           | KPI                                                      | Target                 |
| --------------------------------------------------- | -------------------------------------------------------- | ---------------------- |
| Reduce supplier onboarding time                     | Avg. days from "Not Started" to "Qualified"              | â‰¤5 days                |
| Ensure 100% of active suppliers are qualified       | % of suppliers with `qualification_status = 'qualified'` | 100%                   |
| Increase RFQ response rate from qualified suppliers | % of RFQs responded within 5 days                        | â‰¥95%                   |
| Reduce quality defects from unqualified suppliers   | Defect PPM from unqualified vs qualified suppliers       | 0 PPM from unqualified |
| Automate compliance re-qualification                | % of suppliers re-qualified before expiry                | 100%                   |
| Enable risk-based sourcing                          | % of suppliers approved with conditions or exceptions    | â‰¤20%                   |

---

## 3. ğŸ‘¥ **Target Users & Personas**

| Role                       | Needs                                                                 | Permissions                              |
| -------------------------- | --------------------------------------------------------------------- | ---------------------------------------- |
| **Procurement Manager**    | Onboard, qualify, assign, track, block suppliers                      | Full CRUD, approve, distribute RFQs      |
| **Sourcing Specialist**    | Initiate qualification, collect docs, follow up                       | Create, update, send links               |
| **Quality Manager**        | Review certs, audit reports, approve/reject qualification             | Approve/reject, view docs                |
| **Engineering**            | Validate technical capabilities (tolerances, materials)               | Approve/reject, add technical conditions |
| **Legal/Compliance**       | Review NDAs, terms, insurance, approve qualification                  | Approve/reject, escalate exceptions      |
| **Finance**                | View payment terms, credit limits, historical spend                   | View-only                                |
| **Supplier (Portal User)** | Complete profile, sign NDA, upload certs, track status, submit quotes | View, upload, sign (via link)            |

---

## 4. ğŸ“‹ **Functional Requirements**

### **FR-SM-01: Supplier Database (Core)**
- Maintain centralized supplier profiles with:
  - Basic info (name, contact, address, website, type='supplier')
  - Capabilities (processes, materials, tolerances, certifications)
  - Financial terms (payment terms, currency, credit limit)
  - Performance metrics (on-time delivery %, quality PPM, lead time reliability)
  - Documents (ISO certs, insurance, NDAs, financial statements)
- **RLS**: Organization-scoped â€” each tenant sees only their suppliers.

### **FR-SM-02: Supplier Qualification Workflow**
- **Qualification Status**: `not_started`, `in_progress`, `pending_approval`, `qualified`, `qualified_with_conditions`, `qualified_as_exception`, `rejected`, `expired`
- **Qualification Stages** (Configurable via `workflow_sub_stages`):
  1. **Profile Completion** â†’ Supplier fills in capabilities, materials, tolerances
  2. **NDA Execution** â†’ Supplier signs digital NDA (via DocuSign or PDF upload)
  3. **Document Upload** â†’ Supplier uploads ISO certs, insurance, financials
  4. **Internal Review** â†’ Engineering validates capabilities, Quality validates certs
  5. **Final Approval** â†’ Procurement + Legal approve â†’ status = `qualified` or `qualified_with_conditions` or `qualified_as_exception`
- **Auto-Expiry**: Qualification expires after 12 months â†’ status = `expired` â†’ blocks from RFQs
- **Re-Qualification**: Triggered automatically 30 days before expiry

### **FR-SM-03: Partial & Exceptional Approval**
- Allow approvers to select:
  - âœ… **Approve** â†’ `qualification_status = 'qualified'`
  - âš ï¸ **Approve with Conditions** â†’ Requires `conditions_text`, optional `attached_document_id` â†’ status = `qualified_with_conditions`
  - ğŸš¨ **Approve as Exception** â†’ Requires `exception_justification`, `escalated_to_user_id`, `review_due_date` â†’ status = `qualified_as_exception`
  - âŒ **Reject** â†’ Requires `rejection_reason`
- Conditions must be resolved before supplier can be used in production orders.
- Exceptions auto-expire after 90 days â†’ status = `expired`.

### **FR-SM-04: Capability-Based Filtering (Qualified Only)**
- Filter suppliers by:
  - Manufacturing process (CNC, Injection Molding, Sheet Metal, etc.)
  - Material expertise (Aluminum, Stainless Steel, Plastics, etc.)
  - Tolerance capability (Â±0.01mm, Â±0.05mm, etc.)
  - Certifications (ISO 9001, AS9100, IATF 16949, RoHS, REACH)
  - Geographic region
  - **Qualification Status**: Only show `qualified`, `qualified_with_conditions` (if resolved), or `qualified_as_exception` (if not expired)
- Save filters as "Supplier Lists" (e.g., "Qualified Precision CNC Suppliers â€“ West Coast").

### **FR-SM-05: RFQ Distribution Engine (Qualified Only)**
- From a Project/Quote, select suppliers using saved filters or manual selection.
- System **blocks unqualified suppliers** (status â‰  `qualified`, `qualified_with_conditions` (resolved), `qualified_as_exception` (active)) from selection.
- Auto-package RFQ bundle:
  - Technical drawings (redacted if needed)
  - BOM
  - Quality specs
  - Target price & volume
- Send via secure, expiring email link (no login required for suppliers).
- Track status: Sent â†’ Viewed â†’ Quote Submitted â†’ Quote Overdue.

### **FR-SM-06: Supplier Portal (Qualification + RFQ)**
- Suppliers receive unique link to:
  - **Complete Profile** (if `not_started` or `in_progress`)
  - **Sign NDA** (embedded e-sign or upload signed PDF)
  - **Upload Compliance Docs** (certs, insurance, financials)
  - **View Qualification Status & Requirements**
  - **View RFQs** (only if qualified)
  - **Submit Quotes** (only if qualified)
- No full login/portal in MVP â€” use one-time links with JWT expiration.

### **FR-SM-07: Performance & Compliance Dashboard**
- Track per supplier:
  - Qualification status & expiry date
  - Quote response rate & avg. response time
  - On-time delivery % (linked to `shipments`)
  - Quality defect rate (linked to `nonconformances`)
  - Cost competitiveness (vs. internal cost roll-up)
- Export to Excel/PDF.
- **Compliance Alerts**:
  - "Supplier X qualification expires in 7 days"
  - "Supplier Y missing ISO 9001 cert"

---

## 5. ğŸ—ƒï¸ **Data Model (Supabase DDL)**

### Current Factory Pulse Data Model for Suppliers

In the Factory Pulse system, suppliers are implemented as follows:
- **Supplier Organizations**: Organizations with `organization_type = 'supplier'` in the [organizations](file:///Volumes/Work/Projects/Apillis/Apillis-MFG/factory-pulse/src/integrations/supabase/types-new.ts#L485-L524) table
- **Supplier Contacts**: Contacts with `type = 'supplier'` in the [contacts](file:///Volumes/Work/Projects/Apillis/Apillis-MFG/factory-pulse/src/integrations/supabase/types-new.ts#L637-L678) table, linked to supplier organizations via `organization_id`
- **Supplier Qualification**: Detailed qualification information is stored in a dedicated `supplier_qualifications` table linked to supplier organizations
- **RFQ Management**: Managed through [supplier_rfqs](file:///Volumes/Work/Projects/Apillis/Apillis-MFG/factory-pulse/src/integrations/supabase/types-new.ts#L1829-L1871) table
- **Supplier Quotes**: Managed through [supplier_quotes](file:///Volumes/Work/Projects/Apillis/Apillis-MFG/factory-pulse/src/integrations/supabase/types-new.ts#L1729-L1785) table

### New Table: `supplier_qualifications`

```sql
-- Supplier Qualifications table to store detailed qualification information
CREATE TABLE IF NOT EXISTS public.supplier_qualifications (
  id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  qualification_status TEXT DEFAULT 'not_started' CHECK (qualification_status IN (
    'not_started', 'in_progress', 'pending_approval', 'qualified',
    'qualified_with_conditions', 'qualified_as_exception', 'rejected', 'expired'
  )),
  qualification_expiry DATE,
  qualification_conditions TEXT,
  qualification_conditions_resolved BOOLEAN DEFAULT false,
  qualification_exception_justification TEXT,
  qualification_exception_expires_at DATE,
  qualification_exception_reviewed_by UUID REFERENCES public.users(id),
  overall_score NUMERIC(5,2),
  criteria_scores JSONB DEFAULT '{}'::jsonb,
  recommendations TEXT[],
  valid_until DATE,
  approved_by UUID REFERENCES public.users(id),
  approved_at TIMESTAMPTZ,
  created_by UUID REFERENCES public.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (organization_id)
);

-- Trigger: update_updated_at_column
CREATE TRIGGER set_updated_at
BEFORE UPDATE ON public.supplier_qualifications
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
```

### New Table: `supplier_qualification_progress`

```sql
CREATE TABLE IF NOT EXISTS public.supplier_qualification_progress (
  id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  supplier_id UUID NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  sub_stage_slug TEXT NOT NULL, -- 'profile_complete', 'nda_signed', 'docs_uploaded', 'internal_review', 'final_approval'
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'blocked')),
  completed_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (supplier_id, sub_stage_slug)
);

-- Trigger: update_updated_at_column
CREATE TRIGGER set_updated_at
BEFORE UPDATE ON public.supplier_qualification_progress
FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
```

### Extend `approvals` and `approval_history` (No schema change â€” use `metadata`)

```sql
-- Example approval record for partial approval
INSERT INTO public.approvals (
  entity_type,
  entity_id,
  approval_type,
  status,
  current_approver_id,
  metadata
) VALUES (
  'supplier_qualification',
  'supp-uuid-123',
  'final_approval',
  'approved',
  'user-uuid-456',
  '{
    "decision_type": "partial",
    "conditions": "NDA must be signed within 48h",
    "attached_document_id": "doc-uuid-789"
  }'::jsonb
);
```

### RLS Policies

```sql
-- supplier_qualifications
CREATE POLICY "sq_select_org"
ON public.supplier_qualifications
FOR SELECT USING (organization_id = public.get_current_user_org_id());

CREATE POLICY "sq_update_role"
ON public.supplier_qualifications
FOR UPDATE USING (
  organization_id = public.get_current_user_org_id()
  AND public.get_current_user_role() = ANY(ARRAY['procurement', 'quality', 'engineering', 'management'])
);

-- supplier_qualification_progress
CREATE POLICY "sqp_select_org"
ON public.supplier_qualification_progress
FOR SELECT USING (organization_id = public.get_current_user_org_id());

CREATE POLICY "sqp_update_role"
ON public.supplier_qualification_progress
FOR UPDATE USING (
  organization_id = public.get_current_user_org_id()
  AND public.get_current_user_role() = ANY(ARRAY['procurement', 'quality', 'engineering', 'management'])
);

-- contacts (qualification fields)
CREATE POLICY "contacts_update_qualification"
ON public.contacts
FOR UPDATE USING (
  organization_id = public.get_current_user_org_id()
  AND public.get_current_user_role() = ANY(ARRAY['procurement', 'quality', 'engineering', 'management', 'admin'])
);
```

### Supplier RFQ Table

```sql
-- Supplier RFQ table (already exists in Factory Pulse)
CREATE TABLE IF NOT EXISTS public.supplier_rfqs (
  id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  supplier_id UUID REFERENCES public.contacts(id) ON DELETE CASCADE,
  rfq_number TEXT NOT NULL UNIQUE,
  status TEXT DEFAULT 'draft',
  priority TEXT,
  due_date DATE,
  expected_response_date DATE,
  requirements TEXT,
  special_instructions TEXT,
  sent_at TIMESTAMPTZ,
  viewed_at TIMESTAMPTZ,
  created_by UUID REFERENCES public.users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Supplier Quotes table (already exists in Factory Pulse)
CREATE TABLE IF NOT EXISTS public.supplier_quotes (
  id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES public.organizations(id) ON DELETE CASCADE,
  project_id UUID REFERENCES public.projects(id) ON DELETE SET NULL,
  supplier_id UUID NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  quote_number TEXT,
  status TEXT,
  total_amount NUMERIC(18,2),
  currency TEXT,
  valid_until DATE,
  lead_time_days INTEGER,
  terms_and_conditions TEXT,
  notes TEXT,
  submitted_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 6. ğŸ”„ **Workflow & Qualification Engine**

### Qualification Workflow Steps

1. **Initiate Qualification**:
   - Procurement clicks "Qualify Supplier" â†’ sets `qualification_status = 'in_progress'` in `supplier_qualifications` table
   - System creates `supplier_qualification_progress` records for all 5 sub-stages
   - Sends email to supplier with 3 unique links:
     - Profile: `https://factorypulse.com/supplier/profile/abc123`
     - NDA: `https://factorypulse.com/supplier/nda/def456`
     - Docs: `https://factorypulse.com/supplier/docs/ghi789`

2. **Supplier Completes Tasks**:
   - Supplier updates profile â†’ system sets `sub_stage_slug = 'profile_complete' â†’ status = 'completed'`
   - Supplier signs NDA â†’ uploads to `documents` (category=`supplier_nda`) â†’ system sets `sub_stage_slug = 'nda_signed' â†’ status = 'completed'`
   - Supplier uploads certs â†’ system sets `sub_stage_slug = 'docs_uploaded' â†’ status = 'completed'`

3. **Internal Review**:
   - System sets `qualification_status = 'pending_approval'` in `supplier_qualifications` table
   - Creates `approvals` record with `entity_type = 'supplier_qualification'`, `entity_id = supplier_organization_id`
   - Notifies Engineering + Quality to review

4. **Final Approval**:
   - Approvers choose: Approve, Approve with Conditions, Approve as Exception, Reject
   - If "Approve with Conditions" â†’ require `qualification_conditions`
   - If "Approve as Exception" â†’ require `qualification_exception_justification`, `qualification_exception_reviewed_by`, `qualification_exception_expires_at`
   - System updates `qualification_status`, `qualification_conditions`, `qualification_exception_*` fields in `supplier_qualifications` table
   - Logs in `approval_history`
   - Updates `project_sub_stage_progress` for qualification stage

5. **Re-Qualification & Expiry**:
   - 30 days before expiry â†’ system sets `qualification_status = 'in_progress'`, resets `supplier_qualification_progress`
   - Sends reminder email to supplier
   - 90 days after exception approval â†’ auto-expire â†’ status = `expired`

---

## 7. ğŸ–¼ï¸ **UI/UX Design (Text-Based Figma Spec)**

### Screen 1: Supplier List (Procurement View)

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                          Supplier Management                                                        â”‚
â”‚                             Filter, onboard, qualify, and track performance of your supplier base                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[+] Add New Supplier           [ Save Filter As: "Qualified Precision CNC â€“ West Coast" ]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FILTERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Process: [ CNC Machining â–¼ ]    Material: [ Aluminum â–¼ ]    Tolerance: [ Â±0.01mm â–¼ ]
Certifications: [ ISO 9001 â–¼ ]  Region: [ North America â–¼ ] Status: [ Qualified â–¼ ]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SUPPLIER LIST (28 MATCHES)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[âœ“] Acme Precision Machining    â†’ Status: [ Qualified âœ… ] Exp: Dec 2026
                                â†’ Capabilities: 5-Axis, Â±0.01mm, ISO 9001
                                â†’ Performance: 98% OTD, 80 PPM
                                â†’ [View Profile] [Send RFQ] [Qualify Again] [Performance Report]

[âœ“] Titan Metalworks            â†’ Status: [ Expiring Soon âš ï¸ ] Exp: Oct 2025
                                â†’ Capabilities: Sheet Metal, Welding, ISO 14001
                                â†’ Performance: 92% OTD, 210 PPM
                                â†’ [View Profile] [Send RFQ] [Re-Qualify Now] [Performance Report]

[ ] Global Plastics Inc.        â†’ Status: [ Not Qualified âŒ ] 
                                â†’ [Start Qualification] â†’ 4 steps: Profile, NDA, Docs, Review
                                â†’ [View Profile]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  PAGINATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[ Previous ] 1 2 3 ... 12 [ Next ] â†’ 10 per page
```

### Screen 2: Supplier Qualification Progress

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Acme Precision Machining â€“ Qualification Progress                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Qualification Status: [ Qualified âœ… ]   Expiry: [ Dec 15, 2026 ]   [ Re-Qualify Now ]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  QUALIFICATION STEPS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[âœ“] 1. Profile Completed        â†’ Completed on Sep 1, 2025
[âœ“] 2. NDA Signed               â†’ Signed by John Smith on Sep 2, 2025 â†’ [ View Doc ]
[âœ“] 3. Documents Uploaded       â†’ ISO 9001, Insurance, Financials â†’ [ View All ]
[âœ“] 4. Internal Review          â†’ Approved by Quality on Sep 3, 2025
[âœ“] 5. Final Approval           â†’ Approved by Procurement on Sep 5, 2025

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DOCUMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[âœ“] NDA â€“ Signed.pdf            â†’ Uploaded Sep 2, 2025 â†’ [ Download ]
[âœ“] ISO 9001 Certificate.pdf    â†’ Expires Dec 2026 â†’ [ Download ]
[âœ“] Insurance Certificate.pdf   â†’ Expires Jun 2026 â†’ [ Download ]
[âœ“] Financial Statement.xlsx    â†’ FY 2024 â†’ [ Download ]

[ Request Re-Qualification ]    [ Block Supplier ]    [ Export Qualification Report ]
```

### Screen 3: Final Approval Modal (Approver View)

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Final Approval â€“ Global Plastics Inc.                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  APPROVAL OPTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
( ) Approve â†’ Supplier fully qualified for all projects

( ) Approve with Conditions â†’ Supplier qualified only if conditions are met
    Conditions: [ NDA must be signed within 48 hours of approval.                          ]
                [ Supplier must provide updated ISO 9001 cert by Oct 30, 2025.         ]
    Attach Document: [ Upload ] â†’ [ NDA_Waiver_Signed.pdf ] âœ…

( ) Approve as Exception â†’ Supplier does not meet standards but approved for business need
    Justification: [ Supplier is sole source for material X. Risk accepted by Director of Ops. ]
    Escalate to: [ Maria Chen (Director of Operations) â–¼ ]
    Review Due: [ Jan 15, 2026 ] â†’ Max 90 days from today

( ) Reject â†’ Supplier not qualified
    Reason: [ Material certifications expired and not renewable. ]

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  PREVIEW SUPPLIER STATUS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
If approved with conditions:
â†’ Status: Qualified (with conditions)
â†’ Conditions: "NDA signed within 48h, ISO cert by Oct 30"
â†’ RFQs: Allowed only after conditions resolved

If approved as exception:
â†’ Status: Qualified (exception)
â†’ Expires: Jan 15, 2026
â†’ RFQs: Allowed with manual override + audit log

[ Cancel ]                                                      [ Submit Approval â†’ ]
```

---

## 8. âš™ï¸ **Technical Implementation**

### Frontend Structure (React + TypeScript + Tailwind + DaisyUI)

```tsx
src/features/supplier-management/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SupplierList.tsx
â”‚   â”œâ”€â”€ SupplierProfile.tsx
â”‚   â”œâ”€â”€ SupplierQualificationProgress.tsx
â”‚   â”œâ”€â”€ StartQualificationModal.tsx
â”‚   â”œâ”€â”€ FinalApprovalModal.tsx
â”‚   â””â”€â”€ RFQDistributionModal.tsx
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useSuppliers.ts
â”‚   â”œâ”€â”€ useSupplierQualification.ts
â”‚   â””â”€â”€ useRFQDistribution.ts
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ supplierService.ts
â”‚   â”œâ”€â”€ qualificationService.ts
â”‚   â””â”€â”€ rfqDistributionService.ts
â”œâ”€â”€ types/
â”‚   â””â”€â”€ supplier.types.ts
â””â”€â”€ index.ts
```

### Backend (Supabase RPCs)

```sql
-- RPC: start_supplier_qualification
CREATE OR REPLACE FUNCTION public.start_supplier_qualification(supplier_org_id UUID)
RETURNS JSON AS $$
BEGIN
  -- Insert or update supplier qualification record
  INSERT INTO public.supplier_qualifications (organization_id, qualification_status)
  VALUES (supplier_org_id, 'in_progress')
  ON CONFLICT (organization_id)
  DO UPDATE SET qualification_status = 'in_progress', updated_at = NOW();
  
  -- Insert 5 sub-stage records
  INSERT INTO public.supplier_qualification_progress (...) VALUES (...);
  RETURN json_build_object('status', 'success');
END;
$$ LANGUAGE plpgsql;

-- RPC: approve_supplier_qualification (handles partial/exception)
CREATE OR REPLACE FUNCTION public.approve_supplier_qualification(
  supplier_org_id UUID,
  approver_id UUID,
  decision_type TEXT,
  conditions TEXT DEFAULT NULL,
  exception_justification TEXT DEFAULT NULL,
  escalated_to UUID DEFAULT NULL,
  review_due_date DATE DEFAULT NULL,
  attached_document_id UUID DEFAULT NULL,
  overall_score NUMERIC(5,2) DEFAULT NULL,
  criteria_scores JSONB DEFAULT '{}'::jsonb
)
RETURNS JSON AS $$
BEGIN
  -- Update supplier_qualifications table with approval details
  UPDATE public.supplier_qualifications
  SET 
    qualification_status = CASE 
      WHEN decision_type = 'approve' THEN 'qualified'
      WHEN decision_type = 'partial' THEN 'qualified_with_conditions'
      WHEN decision_type = 'exception' THEN 'qualified_as_exception'
      WHEN decision_type = 'reject' THEN 'rejected'
      ELSE qualification_status
    END,
    qualification_conditions = CASE WHEN decision_type = 'partial' THEN conditions ELSE qualification_conditions END,
    qualification_exception_justification = CASE WHEN decision_type = 'exception' THEN exception_justification ELSE qualification_exception_justification END,
    qualification_exception_expires_at = CASE WHEN decision_type = 'exception' THEN review_due_date ELSE qualification_exception_expires_at END,
    qualification_exception_reviewed_by = CASE WHEN decision_type = 'exception' THEN escalated_to ELSE qualification_exception_reviewed_by END,
    overall_score = overall_score,
    criteria_scores = criteria_scores,
    approved_by = approver_id,
    approved_at = NOW(),
    updated_at = NOW()
  WHERE organization_id = supplier_org_id;

  -- Insert approval + log history
  RETURN json_build_object('status', 'success');
END;
$$ LANGUAGE plpgsql;
```

---

## 9. ğŸ” **Security, Compliance & Audit**

- **RLS**: All tables scoped to `organization_id`
- **Audit Trail**: Log all actions in `activity_log` and `approval_history`
- **Data Redaction**: Strip cost data from drawings before sending to suppliers
- **Link Expiry**: JWT-protected supplier links expire in 7 days
- **Compliance**: Enforce re-qualification every 12 months
- **Retention**: Keep approval history and document versions for 7 years

---

## 10. ğŸ“Š **Reporting & Analytics**

- **Supplier Qualification Dashboard**:
  - % of qualified suppliers
  - Avg. qualification time
  - Expiring soon (next 30 days)
  - Rejected suppliers (with reasons)
- **Exception Report**: List all suppliers with `qualified_as_exception`, expiry dates, justifications
- **Condition Resolution Rate**: % of "qualified_with_conditions" resolved within 30 days
- **Export**: Excel/PDF for supplier reviews

---

## 11. ğŸ”— **Integration Dependencies**

- **Wave 1**: `projects`, `documents`, `quotations` must be deployed
- **Core**: `core/auth`, `core/documents`, `core/approvals`, `core/activity-log`
- **Feature**: `features/intake` (to create projects)
- **APIs**: Use existing `send_email` Edge Function for supplier links
- **Realtime**: Subscribe to `supplier_qualification_progress` for live UI updates

---

## 12. ğŸš€ **Implementation Roadmap (Phased)**

### Phase 1: Core Supplier Database + Qualification Workflow (Weeks 1â€“3)
- Create `supplier_qualifications` and `supplier_qualification_progress` tables
- Build Supplier List + Profile + Qualification Progress UI
- Implement "Start Qualification" flow

### Phase 2: Final Approval with Partial & Exception (Weeks 4â€“5)
- Build `FinalApprovalModal.tsx` with decision options
- Implement Supabase RPCs for approval logic
- Add conditions/exception fields to supplier qualification

### Phase 3: RFQ Distribution + Portal (Weeks 6â€“7)
- Build RFQ Distribution Modal (qualified suppliers only)
- Integrate with `documents` and `supplier_rfqs`
- Send secure links via email

### Phase 4: Performance & Compliance (Weeks 8â€“9)
- Enhance `supplier_qualifications` table with performance metrics
- Add compliance alerts and re-qualification reminders
- Create Supplier Qualification Dashboard

---

## 13. âœ… **Success Metrics & QA Checklist**

### Success Metrics
| Metric                                     | Target  |
| ------------------------------------------ | ------- |
| Supplier qualification rate                | 100%    |
| Avg. qualification time                    | â‰¤5 days |
| RFQ response rate from qualified suppliers | â‰¥95%    |
| Reduction in quality defects               | 50% YoY |
| On-time re-qualification rate              | 100%    |

### QA Checklist
- [ ] RLS policies tested for all new tables
- [ ] Qualification workflow end-to-end tested
- [ ] Partial/exception approval logged in `approval_history`
- [ ] Supplier blocked from RFQ if not qualified
- [ ] Email links expire after 7 days
- [ ] Re-qualification triggered 30 days before expiry
- [ ] Exception auto-expiry after 90 days

---

## 14. ğŸ“ **Appendix**

### Appendix A: Document Categories (Seed Data)

```sql
-- Run once during migration
INSERT INTO public.document_categories (code, name, is_portal_visible, retention_policy)
VALUES
  ('supplier_nda', 'Supplier NDA', true, '{"years": 7}'),
  ('supplier_iso', 'Supplier ISO Certificate', true, '{"years": 3}'),
  ('supplier_insurance', 'Supplier Insurance Certificate', true, '{"years": 2}'),
  ('supplier_financial', 'Supplier Financial Statement', false, '{"years": 7}'),
  ('supplier_qc', 'Supplier Quality Certificate', true, '{"years": 3}');
```

### Appendix B: Enums (Optional)

```ts
// src/features/supplier-management/types/supplier.types.ts
export type QualificationStatus =
  | 'not_started'
  | 'in_progress'
  | 'pending_approval'
  | 'qualified'
  | 'qualified_with_conditions'
  | 'qualified_as_exception'
  | 'rejected'
  | 'expired';

export type ApprovalDecisionType = 'approve' | 'partial' | 'exception' | 'reject';
```

---
